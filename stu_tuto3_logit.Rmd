---
title: "Tuto3 : Régression logistique"
output:
  html_notebook: 
    css: ~/Dropbox/FICHIERS_STYLE/styles.css
    toc: yes
    toc_float: yes
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
theme_set(theme_classic(base_size=12))
```

## Exercice 1 (Modèle logistique simple)

Un chef d'entreprise souhaite vérifier la qualité de ces machines en fonction de l'âge et de la marque des moteurs. Il dispose 

* d'une variable binaire **etat** (1 si le moteur a déjà connu une panne, 0 sinon) ;
* d'une variable quantitative **age** repésentant l'âge du moteur ;
* d'une variable qualitative a 3 modalités **marque** représentant la marque du moteur.

Les données se trouvent dans le fichier *panne.txt*.

1. Importer le jeu de données et, si cela est nécessaire, transformer les variables qualitatives en facteur (on pourra utiliser la commande **as.factor**).


2. Ecrire le modèle logistique permettant d'expliquer la variable $Y$ par la variable **age** uniquement.

On désigne par $X$ la variable *age* et $Y$ la variable *chd*. Le modèle s'écrit

$$\text{logit } p(x)=\beta_0+\beta_1 x$$
où $p(x)=P(Y=1|X=x)$.

3. Ajuster ce modèle logistique sur *R* à l'aide de la fonction *glm*.


4. Quelle est la probabilité estimée par ce modèle qu'une machine d'un an et demi tombe en panne ? Même question pour une machine de 10 ans.



5. Critiquer le modèle.

```{r}
summary(model1)
```

6. On souhaite maintenant constuire le modèle logistique

$$\textrm{logit }p(\textrm{age})=\beta_0+\beta_1\textrm{age}+\beta_2\textrm{age}^2.$$
Expliquer quelles peuvent être les motivations pour envisager un tel modèle.


7. Quelle est la probabilité estimée par ce modèle qu'une machine d'un an et demi tombe en panne ? Même question pour une machine de 10 ans.

8. Représenter l'allure de la fonction $p(\textrm{age})$ en fonction de l'age des machines. Conclure.

## Exercice 2

On considère $X$ une variable aléatoire qualitative qui suit une loi uniforme de support $\{A,B,C\}$ et $Y$ une variable dichotomique telle que :
$$Y|X=A\sim\textrm{Ber}(0.95),\quad Y|X=B\sim\textrm{Ber}(0.95),\quad Y|X=C\sim\textrm{Ber}(0.05).$$

On peut générer un échantillon de taille 100 de ce modèle avec :

```{r}
set.seed(1234)
X <- sample(c("A","B","C"),100,replace=TRUE) %>% as.factor()
Y <- rep(0,100)
Y[X=="A"] <- rbinom(sum(X=="A"),1,0.95)
Y[X=="B"] <- rbinom(sum(X=="B"),1,0.95)
Y[X=="C"] <- rbinom(sum(X=="C"),1,0.05)
donnees <- data.frame(X,Y)
```


1. Expliquer la manière dont on peut prendre en compte une variable expliquative qualitative dans un modèle de régression logistique.


2. Construire le modèle 1 :
$$\textrm{logit} p(x)=\beta_0+\beta_1\mathbf{1}_{x=A}+\beta_2\mathbf{1}_{x=B}+\beta_3\mathbf{1}_{x=C}$$
muni de la contrainte $\beta_1=0$ (on pourra utiliser la fonction **glm**), puis

  * Donner les estimations des paramètres.
  * Faire un **summary** du modèle et analyser les sorties (on précisera notamment les tests effectués).


3. Construire le modèle 2 :
$$\textrm{logit}\, p(x)=\beta_0+\beta_1\mathbf{1}_{x=A}+\beta_2\mathbf{1}_{x=B}+\beta_3\mathbf{1}_{x=C}$$
muni de la contrainte $\beta_3=0$ (on pourra utiliser la fonction **glm** avec **C(X,base=3)**), puis

  * donner les estimations des paramètres.
  * daire un **summary** du modèle et analyser les sorties (on précisera notamment les tests effectués).


4. Comparer les probabilités critiques du test $H_0 : \beta_2=0$ contre $H_1 : \beta_2\neq 0$ pour les deux modèles construits. Interpréter.

5. Proposer et mettre en oeuvre un test statistique permettant de répondre à la question : "Peut-on dire que $X$ à un effet sur $Y$ ?"


## Exercice 3

On considère le jeu de données **SAheart** du package **bestglm**.

```{r message=FALSE, warning=FALSE}
library(bestglm)
data(SAheart)
```

1. Effectuer un test statistique permettant de comparer les modèles logistique expliquant **chd** par 

* *sbp,tobacco,ldl* pour le premier modèle.
* *sbp,tobacco,ldl,obesity,alcohol,age* pour le second modèle.

```{r}
mod1 <- glm(chd~sbp+tobacco+ldl,data=SAheart,family=binomial)
mod2 <- glm(chd~sbp+tobacco+ldl+obesity+alcohol+age,data=SAheart,family=binomial)
anova(mod1,mod2,test="LRT")
```

On rejette ici l'hypothèse nulle, on va donc privilégier le grand modèle.

2. Séparer l'échantillon en un échantillon d'apprentissage de taille 300 et un échantillon test de taille 162.

```{r}
donnees <- SAheart
set.seed(1234)
ind.app <- sample(nrow(donnees),300)
dapp <- donnees[ind.app,]
dtest <- donnees[-ind.app,]
```


3. A l'aide de l'échantillon d'apprentissage **uniquement**, sélectionner des variables en utilisant
 
  * une procédure de recherche exhaustive pour les critères AIC et BIC ;
  * une procédure pas à pas descendante pour le critère AIC.

Ajuster également un modèle d'analyse discriminante linéaire et quadratique.


4. Expliquer l'argument *type* de la fonction **predict.glm**. Calculer un score des individus de l'échantillon test pour chaque modèle ajusté précédemment.


5. Proposer une règle de prévision construite à partir des modèles sélectionnés ainsi qu'un critère de performance pour la règle construite.


6. Comparer les règles associées aux 4 modèles construits en calculant l'erreur de classification, puis en dressant les tables de confusion.

7. Tracer les courbe ROC et calculer les AUC.






